\section{Efficiency Evaluation}
  \label{section:comparison}
  We offer here a comparison of this work with
  LVPC~\cite{10.1007/978-3-030-65411-5_18}, BCVC~\cite{9519487}
  and Donner~\cite{donner} in terms of communication efficiency when opening and
  updating. We also compare
  the maximum on-chain cost for an endpoint to unilaterally close its virtual
  channel. Furthermore, we compare the worst-case on-chain cost for an
  intermediary to close its base channel. Note that, in order to only show the
  costs caused by supporting a virtual channel, we subtract the cost the
  intermediary would pay to close its channel if it was not supporting any
  virtual channel. Lastly, we compare the worst-case total on-chain cost,
  aggregated over all parties. On-chain cost is measured in terms of
  size\footnote{For Table~\ref{table:comparison:overhead:n-parties:close},
  transaction size is calculated in so-called ``virtual bytes'', which map
  directly to on-chain fees and thus are preferred to raw bytes. For
  Table~\ref{table:comparison:overhead:3-parties}, transaction size is
  calculated in raw bytes instead, to better align with the counting method used
  in the efficiency evaluation found in~\cite{9519487}. We used the tool found
  in \url{https://jlopp.github.io/bitcoin-transaction-size-calculator/} to aid
  size calculation.} and number of transactions. The comparison is performed
  both for channels of length $3$ and for channels of length $n$. In the second
  comparison BCVC is not included, since only LVPC and Donner offer a way to
  open virtual channels of length greater than $3$ (since LVPC is recursive and
  Donner is variadic). For a virtual channel between $P_1$ and $P_n$ over $n-1$
  base channels via LVPC, we consider the case in which the funder $P_1$
  initially has a channel with $P_2$ and then opens one virtual channel with
  party $P_i$ on top of its channel with party $P_{i-1}$ for $i \in \{3, \dots,
  n\}$. We choose this topology, as $P_1$ cannot assume that there exist any
  virtual channels between other parties (which could be used as shortcuts).

  BCVC proposes $4$ configurations, each with different efficiency
  characteristics: over Generalised Channels~\cite{DBLP:journals/iacr/AumayrEEFHMMR20} (GC)
  or Lightning, and with or without validity (V or NV respectively); we include
  all of them here. We refer the reader to~\cite{9519487} for more
  details.

  Since all constructions produce pairwise channels, updates (a.k.a.\ payments)
  always implicate exactly two parties and
  their interaction is independent of the number of underlying channels.
  Therefore the ``Update'' entries in
  Table~\ref{table:comparison:overhead:3-parties} also cover the general case of
  $n$ underlying channels. \emph{Party rounds} are calculated as
  [\#incoming messages + \#outgoing messages]/2, for each party
  separately. Note that the update-related storage requirements of Elmo-related
  entries in Table~\ref{table:comparison:overhead:3-parties} do not take into
  account savings that may arise by deleting old unneeded data at the end of an
  update.

  Some results disagree slightly with those of the tables found in related work,
  due to differences in the counting method. Also note that the data for Elmo
  are derived assuming a virtual channel opened directly on top of $n-1$ base
  channels, in other words the channel considered is opened without the help of
  recursion.

  \addtolength{\intextsep}{-15pt}
  \begin{table}[h!]
    \begin{minipage}{\textwidth}
    \centering
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|}
    \hline
              & \multicolumn{2}{|c|}{Open}
              & \multicolumn{2}{|c|}{Update}
              & \multicolumn{2}{|c|}{Cooperative Close}
              & \multicolumn{2}{|c|}{Unilateral Close} \\
    \hline
              & \#txs & size & \#txs & size & \#txs & size & \#txs & size \\
    \hline
    BCVC-GC-NV
              & 7 & 2829 & 2 & 695 & 4 & 1390 & 7 & 2829 \\
    \hline
    BCVC-GC-V & 8 & 2803 & 2 & 695 & 4 & 1390 & 8 & 2803 \\
    \hline
    BCVC-LN-NV
              & 16 & 7704 & 8 & 2824 & 4 & 1412 & 4 & 2153 \\
    \hline
    BCVC-LN-V & 14 & 5722 & 4 & 1412 & 4 & 1412 & 5 & 2131 \\
    \hline
    Elmo      & 7 & 5245 & 4 & 1517 & 20 & 8002 & 4 & 2223 \\
    \hline
    \end{tabular}
    \end{minipage}
    \caption{Efficiency comparison of a $3$-party channel in Elmo and
    BCVC~\cite{9519487}}
    \label{table:comparison:overhead:3-parties}
  \end{table}
  \addtolength{\intextsep}{15pt}

  In Table~\ref{table:comparison:overhead:n-parties:open} we compare the
  resources needed to open a new virtual channel both for each party
  individually and for all parties in total, in terms of party rounds and amount
  of data sent and stored. The data is counted as the sum of the relevant
  channel identifiers ($8$ bytes each, as defined by the Lightning Network
  specification\footnote{\url{https://github.com/lightning/bolts/blob/master/07-routing-gossip.md\#definition-of-short_channel_id}}),
  transaction output identifiers ($36$ bytes), secret keys ($32$ bytes each),
  public keys ($32$ bytes each, compressed form -- these double as party
  identifiers), Schnorr signatures ($64$ bytes each), coins ($8$ bytes each),
  times and timelocks (both $4$ bytes each). The resources are exact for $n \geq
  4$ parties, whereas for $n = 3$ they slightly overestimate. UC-specific data
  is ignored.

  In LVPC, every intermediary, apart from the first one, acts both as a fundee
  in a new virtual channel with the funder and as an intermediary in the
  funder's virtual channel with the party after said intermediary. In
  Table~\ref{table:comparison:overhead:n-parties:open} the intermediary columns
  contain the total cost of any intermediary that is not the first one,
  therefore the first intermediary (the party after the funder) incurs
  [intermediary's costs - fundee's costs] for all three measured quantities.

  \addtolength{\intextsep}{-15pt}
  \begin{table}[h!]
    \resizebox{\textwidth}{!}{%
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|c|c|c|}
    \hline
    \multicolumn{12}{|c|}{Open} \\
    \hline
    \multirow{3}{*}{}
              & \multicolumn{3}{|c|}{Funder} & \multicolumn{3}{|c|}{Fundee}
              & \multicolumn{3}{|c|}{Intermediary}
              & \multicolumn{2}{|c|}{Total} \\
    \cline{2-12}
              & \multirow{2}{*}{\shortstack{party \\ rounds}}
              & \multicolumn{2}{|c|}{size} & \multirow{2}{*}{\shortstack{party
              \\ rounds}} & \multicolumn{2}{|c|}{size}
              & \multirow{2}{*}{\shortstack{party \\ rounds}}
              & \multicolumn{2}{|c|}{size} & \multicolumn{2}{|c|}{size} \\
    \cline{3-4} \cline{6-7} \cline{9-12}
              & & sent & stored & & sent & stored & & sent & stored & sent &
              stored \\
    \hline
    LVPC      & $8(n-2)$ & $1381(n-2)$ & $3005(n-2)$ & $7$ & $1254$ & $2936$
              & $16$ & $2989$ & $6385$ & $4370n-8740$ & $9390n-18780$ \\
    \hline
    % my count
    %Donner     & $2$ & $164n + 1934$ & $108n + 2150$ & $1$ & $44n+128$
    %           & $176n+496$ & $1$ & $76n + 2010$ & $132n+2370$
    %           & $132n^2+2390n-2094$ & $76n^2+2066n-1858$ \\
    %\hline
    \multirow{2}{*}{Donner}
              & \multirow{2}{*}{$2$} & \multirow{2}{*}{$184n + 829$}
              & \multirow{2}{*}{\shortstack{$1332.5k+$ \\ $43n+125.5$}}
              & \multirow{2}{*}{$1$} & \multirow{2}{*}{$43n+192.5$}
              & \multirow{2}{*}{\shortstack{$1332.5k+$ \\ $43n+125.5$}}
              & \multirow{2}{*}{$1$} & \multirow{2}{*}{$547$}
              & \multirow{2}{*}{\shortstack{$1332.5k+$ \\ $43n+125.5$}}
              & \multirow{2}{*}{$774n-71$}
              & \multirow{2}{*}{\shortstack{$1332.5kn +$ \\ $43n^2 + 125.5n$}}
              \\
              & & & & & & & & & & & \\
              % For Donner, I drew the storage numbers from
              % https://eprint.iacr.org/2021/855.pdf, p. 22. I'm not sure what
              % pid is, so these numbers may have to be revised.
    \hline
    \multirow{3}{*}{Elmo}
              & \multirow{3}{*}{$6$} &
              \multirow{3}{*}{\shortstack{$32n^3-128n^2$ \\
              $+544n-276$}} &
              \multirow{3}{*}{\shortstack{$\frac{128}{3}n^3-128n^2$ \\
              $+\frac{1276}{3}n+220$}} &
              \multirow{3}{*}{$6$}
              & \multirow{3}{*}{\shortstack{$32n^3-128n^2$ \\
              $+544n-340$}} &
              \multirow{3}{*}{\shortstack{$\frac{128}{3}n^3-128n^2$ \\
              $+\frac{1276}{3}n+220$}} &
              \multirow{3}{*}{$12$}
              & \multirow{3}{*}{\shortstack{$96n^3-256n^2$ \\
              $+404n-40$}}
              & \multirow{3}{*}{\shortstack{$96n^3-256n^2$ \\
              $+468n+88$}}
              & \multirow{3}{*}{\shortstack{$96n^4-384n^3+$ \\
              $724n^2+240n-792$}} &
              \multirow{3}{*}{\shortstack{$96n^4-\frac{1088}{3}n^3+$ \\
              $660n^2+\frac{8}{3}n+520$}}\\
              & & & & & & & & & & & \\
              & & & & & & & & & & & \\
    \hline
    \end{tabular}}
    \caption{Open efficiency comparison of virtual channel protocols with $n$
    parties and $k$ payments}
    \label{table:comparison:overhead:n-parties:open}
  \end{table}

  \begin{table}[h!]
    \begin{minipage}{\textwidth}
    \centering
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|}
    \hline
    \multicolumn{9}{|c|}{Unilateral Close} \\
    \hline
              & \multicolumn{2}{|c|}{Intermediary}
              & \multicolumn{2}{|c|}{Funder} & \multicolumn{2}{|c|}{Fundee}
              & \multicolumn{2}{|c|}{Total} \\
    \hline
              & \#txs & size & \#txs & size & \#txs & size & \#txs & size \\
    \hline
    LVPC      & $3$ & $627$ & $2$ & $383$ & $2$ & $359$ & $2n-2$ & $435n -
              510.5$ \\
    \hline
    Donner    & $1$ & $204.5$ & $4$ & $704 + 43n$ & $1$ & $136.5$ & $2n$ & $458n
              - 26$ \\
    \hline
    Elmo      & $1$ & $594 + 27n$ & $2$ & $503$ & $2$ & $503$ & $n$
              & \begin{tabular}{@{}c@{}}$27n^2 + 541n$ \\ $-
              684.5$\end{tabular} \\
    \hline
    \begin{tabular}{@{}l@{}}Elmo \\ (optimised)\end{tabular}
              & $1$ & $594 + 27n \TODO{rethink}$ & $2$ & $503 \TODO{remove 1pk ,
              1sig, add 27
              bytes}$ & $2$ & $503 \TODO{copy from funder}$ & $n$
              & \begin{tabular}{@{}c@{}}$27n^2 + 541n$ \\ $-
              684.5$\end{tabular} \TODO{rethink} \\
    \hline
    \end{tabular}
    \end{minipage}
    \caption{On-chain worst-case closing efficiency comparison of virtual
    channel protocols with $n$ parties}
    \label{table:comparison:overhead:n-parties:close}
  \end{table}
  \addtolength{\intextsep}{15pt}

  The on-chain number of transactions to close a virtual channel in the case of
  LVPC is calculated as follows: One ``split'' transaction is needed for each
  base channel ($n-1$ in total), plus one ``merge'' transaction per virtual
  channel ($n-2$ in total), plus a single ``refund'' transaction for the virtual
  channel, for a total of $2n-2$ transactions.

  We note that the linear size factor when the intermediary closes can, in the
  case of our work, be eliminated with the aid of Schnorr signatures (recently
  added to Bitcoin), bringing its cost below that of LVPC. This is so
  because the $n$ signatures that are
  needed to spend each virtual output can be reduced to a single aggregate
  signature without compromising security. Likewise, Schnorr
  signatures help eliminate the quadratic term and reduce the linear term of the
  total on-chain cost, as well as reduce the required storage. The same cannot
  be said for the linear factor in Donner,
  since Schnorr signatures cannot optimise away the $n$ outputs of the
  funder's transaction $\tx^{\mathtt{vc}}$. Likewise LVPC cannot gain a linear
  improvement with this optimisation, since each of its relevant transactions
  (``split'', ``merge'' and ``refund'') needs constant
  signatures. We deduce that, using this optimisation, Elmo has the smallest
  worst-case total on-chain footprint compared to LVPC and Donner.
