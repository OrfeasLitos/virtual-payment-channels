\section{Security Proof}
  When \environment sends (\textsc{fund}, $c$, hops, (fundee, counterparty),
  (\charlie, \dave), $pk_{\mathit{VA}, out}$, $pk_{\mathit{VB}, out}$) to \alice
  in the real world,
  lines~\ref{code:functionality:chan:skeleton:virtual:fund}-\ref{code:functionality:chan:skeleton:virtual:subfunc}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} are executed and then
  control is handed over to the ``fundee'' ITI, which executes
  lines~\ref{code:protocol:chan:skeleton:vchan:open-virtual}-\ref{code:protocol:chan:skeleton:vchan:open-virtual:output}
  of Fig.~\ref{code:protocol:chan:skeleton:virtual}.  This ITI will output
  (\textsc{ok}) if and only if line~\ref{code:protocol:chan:skeleton:vchan:ln}
  of Fig.~\ref{code:protocol:chan:skeleton:virtual} succeeds.

  When \environment sends (\textsc{fund}, $c$, hops, (fundee, counterparty),
  (\charlie, \dave)) to \alice in the ideal world,
  lines~\ref{code:functionality:chan:skeleton:virtual:fund}-\ref{code:functionality:chan:skeleton:virtual:subfunc}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} are executed and then
  control is handed over to the functionality that controls the ``fundee'',
  which executes
  lines~\ref{code:functionality:chan:skeleton:virtual:open-virtual}-\ref{code:functionality:chan:skeleton:virtual:inform}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} and then hands control
  over to \simulator. The latter in turn simulates
  lines~\ref{code:protocol:chan:skeleton:vchan:open-virtual}-\ref{code:protocol:chan:skeleton:vchan:open-virtual:output}
  of Fig.~\ref{code:protocol:chan:skeleton:virtual}, thus following the exact
  same steps as in the real world, therefore it will send (\textsc{ok}) to
  \fchan if and only if the simulated
  line~\ref{code:protocol:chan:skeleton:vchan:ln} of
  Fig.~\ref{code:protocol:chan:skeleton:virtual} succeeds. From this and the
  previous paragraph, we see that, up to this point, the two worlds are
  perfectly indistinguishable.

  Moving on, in the ideal world subsequently
  lines~\ref{code:functionality:chan:skeleton:virtual:id}-\ref{code:functionality:chan:skeleton:virtual:fund:leak}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} are executed, which
  results in \simulator executing
  lines~\ref{code:simulator:fund}-\ref{code:simulator:fund:ok} of
  Fig.~\ref{code:simulator:pt1}. During the latter steps, \simulator simulates
  executing line~\ref{code:functionality:chan:skeleton:virtual:fund:init} of
  Fig.~\ref{code:functionality:chan:skeleton:virtual} with \alice.

  Similarly in the real world, \alice executes
  lines~\ref{code:functionality:chan:skeleton:virtual:id}
  and~\ref{code:functionality:chan:skeleton:virtual:fund:init} of
  Fig.~\ref{code:functionality:chan:skeleton:virtual}, therefore the two
  worlds still are perfectly indistinguishable.

  The ``for'' loop of
  lines~\ref{code:functionality:chan:skeleton:virtual:fund:for:allow:start}-\ref{code:functionality:chan:skeleton:virtual:fund:for:allow:end}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} is then executed in
  both the real and the ideal worlds. The message of
  line~\ref{code:functionality:chan:skeleton:virtual:fund:for:allow:send}
  results in the execution of
  lines~\ref{code:protocol:chan:skeleton:vchan:open-virtual}-\ref{code:protocol:chan:skeleton:vchan:open-virtual:output}
  of Fig.~\ref{code:protocol:chan:skeleton:virtual} by $L_i$ in both worlds: in
  the real world directly, in the ideal world simulated by \simulator.

  In the ideal world,
  line~\ref{code:functionality:chan:skeleton:virtual:fund:simulate} in
  Fig.~\ref{code:functionality:chan:skeleton:virtual} prompts \simulator to
  simulate line~\ref{code:protocol:chan:skeleton:vchan} of
  Fig.~\ref{code:protocol:chan:skeleton:virtual} with \alice, which is exactly
  the code that would be directly run by \alice in the real world. Therefore the
  two worlds remain perfectly indistinguishable.

  The ``for'' loop of
  lines~\ref{code:functionality:chan:skeleton:virtual:fund:confirm}-\ref{code:functionality:chan:skeleton:virtual:fund:store}
  of Fig.~\ref{code:functionality:chan:skeleton:virtual} is also perfectly
  indistinguishable in the two worlds. With argumentation similar to that of the
  previous ``for'' loop, we conclude that the \textsc{fund} message does not
  induce any chance of distinguishability between the two worlds.

