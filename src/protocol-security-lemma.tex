\begin{lemma}[Real world balance security]
\label{lemma:real-balance-security}
  Consider a real world execution with $P \in \{\alice, \bob\}$ honest
  \textsc{ln} ITI and $\bar{P}$ the counterparty ITI. Assume that all of the
  following are true:
  \begin{itemize}
    \item the internal variable \texttt{negligent} of $P$ has value ``False'',
    \item $P$ has transitioned to the \textsc{open} \textit{State} for the first
    time after having received $(\textsc{open}, c, \dots)$ by either
    \environment or $\bar{P}$,
    \item $P$ [has received $(\textsc{fund me}, f_i, \dots)$ as input by another
    \textsc{ln} ITI while \textit{State} was \textsc{open} and subsequently $P$
    transitioned to \textsc{open} \textit{State}] $n$ times,
    \item $P$ [has received $(\textsc{pay}, d_i)$ by \environment while
    \textit{State} was \textsc{open} and $P$ subsequently transitioned to
    \textsc{open} \textit{State}] $m$ times,
    \item $P$ [has received $(\textsc{get paid}, e_i)$ by \environment while
    \textit{State} was \textsc{open} and $P$ subsequently transitioned to
    \textsc{open} \textit{State}] $l$ times.
  \end{itemize}
  Let $\phi = 1$ if $P = \alice$, or $\phi = 0$ if $P = \bob$. If $P$ receives
  $(\textsc{close})$ by \environment and, if $\texttt{host}_P \neq \ledger$
  the output of $\texttt{host}_P$ is (\textsc{closed}), then eventually the
  state obtained when $P$ inputs $(\textsc{read})$ to \ledger will contain $h$
  $(c_i, \pk{P, \mathrm{out}})$ outputs such that
  \begin{equation}
  \label{lemma:real-balance-security:ineq}
    \sum\limits_{i=1}^h c_i \geq \phi \cdot c - \sum\limits_{i=1}^n f_i -
    \sum\limits_{i=1}^m d_i + \sum\limits_{i=1}^l e_i \enspace
  \end{equation}
  with overwhelming probability in the security parameter.
\end{lemma}

\begin{proof}
  We first note that, as signature forgeries only happen with negligible
  probability and only a polynomial number of signatures are verified by honest
  parties throughout an execution, the event in which any forged signature
  passes the verification of an honest party or of \ledger happens only with
  negligible probability. We can therefore ignore this event throughout this
  proof and simply add a computationally negligible distance between
  \environment's outputs in the real and the ideal world at the end.

  Define the \emph{history} of a channel as $H = (F, C)$, where each of $F, C$
  is a list of lists of integers. A party $P$ which satisfies the Lemma
  conditions has a unique, unambiguously and recursively defined history: If the
  value \texttt{hops} in the (\textsc{open}, $c$, $\texttt{hops}$, $\dots$)
  message was equal to \ledger, then $F$ is the empty list, otherwise $F$ is the
  concatenation of the $F$ and $C$ lists of the party that sent
  (\textsc{funded}, $\dots$) to $P$, as they were at the moment the latter
  message was sent. After initialised, $F$ remains immutable. Observe that, if
  $\texttt{hops} \neq \ledger$, both aforementioned messages must have been
  received before $P$ transitions to the \textsc{open} state.

  The list $C$ of party $P$ is initialised to $[[g]]$ when $P$'s $\itistate$
  transitions for the first time to \textsc{open}, where $g = c$ if $P =
  \alice$, or $g = 0$ if $P = \bob$; this represents the initial channel
  balance. The value $x$ or $-x$ is appended to the last list in $C$ when a
  payment is received (Fig.~\ref{code:ln:pay:revocations},
  l.~\ref{code:ln:pay:revocations:paid-in}) or sent
  (Fig.~\ref{code:ln:pay:revocations},
  l.~\ref{code:ln:pay:revocations:paid-out}) respectively by $P$. Moving on to
  the funding of new virtual channels, whenever $P$ funds a new virtual channel
  (Fig.~\ref{code:ln:virtualise:start-end},
  l.~\ref{code:ln:virtualise:start-end:reduce-coins}), $[-c_{\mathrm{virt}}]$
  is appended to $C$ and whenever $P$ helps with the opening of a new virutal
  channel, but does not fund it (Fig.~\ref{code:ln:virtualise:start-end},
  l.~\ref{code:ln:virtualise:start-end:reply}), $[0]$ is appended to $C$.
  Therefore $C$ consists of one list of integers for each sequence of inbound
  and outbound payments that have not been interrupted by a virtualisation step
  and a new list is added for every new virtual layer. We also observe that a
  non-negligent party with history $(F, C)$ satisfies the Lemma conditions and
  that the value of the right hand side of the
  inequality~(\ref{lemma:real-balance-security:ineq}) is equal to
  $\sum\limits_{s \in C} \sum\limits_{x \in s} x$, as all inbound and outbound
  payment values and new channel funding values that appear in the Lemma
  conditions are recorded in $C$.

  Let party $P$ with a particular history. We will inductively prove that $P$
  satisfies the Lemma. The base case is when a channel is opened with
  $\texttt{hops} = \ledger$ and is closed right away, therefore $H = ([], [g])$,
  where $g = c$ if $P = \alice$ and $g = 0$ if $P = \bob$.  $P$ can transition
  to the \textsc{open} \textit{State} for the first time only if all of the
  following have taken place:
  \begin{itemize}
    \item It has received (\textsc{open}, $c$, $\dots$) while in the
    \textsc{init} \textit{State}. In case $P = \alice$, this message must have
    been received as input by \environment (Fig.~\ref{code:ln:open},
    l.~\ref{code:ln:open:alice-open}), or in case $P = \bob$, this message must
    have been received via the network by $\bar{P}$
    (Fig.~\ref{code:ln:exchange-open-keys},
    l.~\ref{code:ln:exchange-open-keys:bob-open}).
    \item It has received $\pk{\bar{P}, F}$. In case $P = \bob$, $\pk{\bar{P},
    F}$ must have been contained in the (\textsc{open}, $\dots$) message by
    $\bar{P}$ (Fig.~\ref{code:ln:exchange-open-keys},
    l.~\ref{code:ln:exchange-open-keys:bob-open}), otherwise if $P = \alice$
    $\pk{\bar{P}, F}$ must have been contained in the (\textsc{accept channel},
    $\dots$) message by $\bar{P}$ (Fig.~\ref{code:ln:exchange-open-keys},
    l.~\ref{code:ln:exchange-open-keys:accept-channel}).
    \item It internally holds a signature on the commitment transaction $C_{P,
    0}$ that is valid when verified with public key $\pk{\bar{P}, F}$
    (Fig.~\ref{code:ln:exchange-open-sigs},
    ll.~\ref{code:ln:exchange-open-sigs:b-verify}
    and~\ref{code:ln:exchange-open-sigs:a-verify}).
    \item It has the transaction $F$ in the \ledger state
    (Fig.~\ref{code:ln:commit-base}, l.~\ref{code:ln:commit-base:f-in-state} or
    Fig.~\ref{code:ln:bob}, l.~\ref{code:ln:bob:state-open}).
  \end{itemize}

  We observe that $P$ satisfies the Lemma conditions with $m = n = l = 0$.
  Before transitioning to the \textsc{open} \textit{State}, $P$ has produced
  only one valid signature for the ``funding'' output $(c, 2/\{\pk{P, F},
  \pk{\bar{P}, F}\})$ of $F$ with $\sk{P, F}$, namely for $C_{\bar{P}, 0}$
  (Fig.~\ref{code:ln:exchange-open-sigs},
  ll.~\ref{code:ln:exchange-open-sigs:a-sign}
  or~\ref{code:ln:exchange-open-sigs:b-sign}), and sent it to $\bar{P}$
  (Fig.~\ref{code:ln:exchange-open-sigs},
  ll.~\ref{code:ln:exchange-open-sigs:a-send}
  or~\ref{code:ln:exchange-open-sigs:b-send}), therefore the only two ways to
  spend $(c, 2/\{\pk{P, F}, \pk{\bar{P}, F}\})$ are by either publishing $C_{P,
  0}$ or $C_{\bar{P}, 0}$. We observe that $C_{P, 0}$ has a ($g$, ($\pk{P,
  \mathrm{out}} + (t + s)$) $\vee$ $2/\{\pk{P, R}, \pk{\bar{P}, R}\}$) output
  (Fig.~\ref{code:ln:exchange-open-sigs},
  l.~\ref{code:ln:exchange-open-sigs:a-tx}
  or~\ref{code:ln:exchange-open-sigs:b-tx}). The spending method $2/\{\pk{P, R},
  \pk{\bar{P}, R}\}$ cannot be used since $P$ has not produced a signature for
  it with $\sk{P, R}$, therefore the alternative spending method, $\pk{P,
  \mathrm{out}} + (t + s)$, is the only one that will be spendable if $C_{P, 0}$
  is included in \ledger, thus contributing $g$ to the sum of outputs that
  contribute to inequality~(\ref{lemma:real-balance-security:ineq}). Likewise,
  if $C_{\bar{P}, 0}$ is included in \ledger, it will contribute at least one
  ($g$, $\pk{P, \mathrm{out}}$) output to this inequality, as $C_{\bar{P}, 0}$
  has a ($g$, $\pk{P, \mathrm{out}}$) output
  (Fig.~\ref{code:ln:exchange-open-sigs},
  l.~\ref{code:ln:exchange-open-sigs:a-tx}
  or~\ref{code:ln:exchange-open-sigs:b-tx}). Additionally, if $P$ receives
  (\textsc{close}) by \environment while $H = ([], [g])$, it attempts to publish
  $C_{P, 0}$ (Fig.~\ref{code:ln:close}, l.~\ref{code:ln:close:submit}), and will
  either succeed or $C_{\bar{P}, 0}$ will be published instead. We therefore
  conclude that in every case \ledger will eventually have a state $\Sigma$ that
  contains at least one $(g, \pk{P, \mathrm{out}})$ output, therefore satisfying
  the Lemma consequence.

  Let $P$ with history $H = (F, C)$. The induction hypothesis is that the Lemma
  holds for $P$. Let $c_P$ the sum in the right hand side of
  inequality~(\ref{lemma:real-balance-security:ineq}). In order to perform the
  induction step, assume that $P$ is in the \textsc{open} state. We will prove
  all the following (the facts to be proven are shown with emphasis for
  clarity):
  \begin{itemize}
    \item If $P$ receives (\textsc{fund me}, $f$, $\dots$) by a (local, trusted)
    \textsc{ln} ITI $R$, subsequently transitions back to the \textsc{open}
    state (therefore moving to history $(F, C')$ where $C'$ is $C + [-f]$) and
    finally receives (\textsc{close}) by \environment and (\textsc{closed}) by
    $\texttt{host}_P$ before any further change to its history, then
    \emph{eventually $P$'s \ledger state will contain $h$ $(c_i, \pk{P,
    \mathrm{out}})$ transaction outputs such that $\sum\limits_{i=1}^h c_i \geq
    \sum\limits_{s \in C} \sum\limits_{x \in s} x$}. Furthermore, given that $P$
    moves to the \textsc{open} state after the (\textsc{fund me}, $\dots$)
    message, it also sends (\textsc{funded}, $\dots$) to $R$
    (Fig.~\ref{code:ln:virtualise:start-end},
    l.~\ref{code:ln:virtualise:start-end:funder-funded}). If subsequently the
    state of $R$ transitions to \textsc{open} (therefore obtaining history
    $(F_R, C_R)$ where $F_R = F + C$ and $C_R = [[f]]$), and finally receives
    (\textsc{close}) by \environment and (\textsc{closed}) by $\texttt{host}_R$
    ($\texttt{host}_R = \texttt{host}_P$ -- Fig.~\ref{code:ln:bob},
    l.~\ref{code:ln:bob:host}) before any further change to its history, then
    \emph{eventually $R$'s \ledger state will contain $k$ $(c^R_i, \pk{R,
    \mathrm{out}})$ transaction outputs such that $\sum\limits_{i=1}^k c^R_i
    \geq \sum\limits_{s \in C_R} \sum\limits_{x \in s} x$}.
    \item If $P$ receives (\textsc{virtualise}, $\dots$) by an \textsc{ln} ITI
    $R$, subsequently transitions back to \textsc{open} (therefore moving to
    history $(F, C')$ where $C'$ is $C + [0]$) and finally receives
    \textsc{close} by \environment and (\textsc{closed}) by $\texttt{host}_P$
    before any further change to its history, then \emph{eventually $P$'s
    \ledger state will contain $h$ $(c_i, \pk{P, \mathrm{out}})$ transaction
    outputs such that $\sum\limits_{i=1}^h c_i \geq \sum\limits_{s \in C}
    \sum\limits_{i \in s} i$}. Furthermore, given that $P$ moves to the
    \textsc{open} state after the (\textsc{virtualise}, $\dots$) message and in
    case it sends (\textsc{funded}, $\dots$) to some party $R$
    (Fig.~\ref{code:ln:virtualise:start-end},
    l.~\ref{code:ln:virtualise:start-end:helper-output-funded}), the latter
    party is the (local, trusted) \texttt{fundee} of a new virtual channel. If
    subsequently the state of $R$ transitions to \textsc{open} (therefore
    obtaining history $(F_R, C_R)$ where $F_R = F + C$ and $C_R = [[0]]$), and
    finally receives (\textsc{close}) by \environment and (\textsc{closed}) by
    $\texttt{host}_R$ ($\texttt{host}_R = \texttt{host}_P$ --
    Fig.~\ref{code:ln:bob}, l.~\ref{code:ln:bob:host}) before any further change
    to its history, then \emph{eventually $R$'s \ledger state will contain $k$
    $(c^R_i, \pk{R, \mathrm{out}})$ transaction outputs such that
    $\sum\limits_{i=1}^k c^R_i \geq \sum\limits_{s \in C_R} \sum\limits_{x \in
    s} x$}.
    \item If $P$ receives (\textsc{pay}, $d$) by \environment, subsequently
    transitions back to \textsc{open} (therefore moving to history $(F, C')$
    where $C'$ is $C$ with $-d$ appended to the last list of $C$) and finally
    receives \textsc{close} by \environment and (\textsc{closed}) by
    $\texttt{host}_P$ (the latter only if $\texttt{host}_P \neq \ledger$ or
    equivalently $F \neq []$) before any further change to its history, then
    \emph{eventually $P$'s \ledger state will contain $h$ $(c_i, \pk{P,
    \mathrm{out}})$ transaction outputs such that $\sum\limits_{i=1}^h c_i \geq
    \sum\limits_{s \in C} \sum\limits_{i \in s} i$}.
    \item If $P$ receives (\textsc{get paid}, $e$) by \environment, subsequently
    transitions back to \textsc{open} (therefore moving to history $(F, C')$
    where $C'$ is $C$ with $e$ appended to the last list of $C$) and finally
    receives \textsc{close} by \environment and (\textsc{closed}) by
    $\texttt{host}_P$ (the latter only if $\texttt{host}_P \neq \ledger$ or
    equivalently $F = []$) before any further change to its history, then
    \emph{eventually $P$'s \ledger state will contain $h$ $(c_i, \pk{P,
    \mathrm{out}})$ transaction outputs such that $\sum\limits_{i=1}^h c_i \geq
    \sum\limits_{s \in C} \sum\limits_{i \in s} i$}.
  \end{itemize}

  When $P$ is in the \textsc{open} state and receives (\textsc{fund me}, $f$,
  $\dots$), it can only move again to the \textsc{open} state after doing the
  following state transitions: \textsc{open} $\rightarrow$ \textsc{virtualising}
  $\rightarrow$ \textsc{waiting for revocation} $\rightarrow$ \textsc{waiting
  for inbound revocation} $\rightarrow$ \textsc{waiting for hosts ready}
  $\rightarrow$ \textsc{open}. During this sequence of events, a new
  $\texttt{host}_P$ is defined (Fig.~\ref{code:ln:virtualise:start-end},
  l.~\ref{code:ln:virtualise:start-end:define}), new commitment transactions are
  negotiated with $\bar{P}$ (Fig.~\ref{code:ln:virtualise:start-end},
  l.~\ref{code:ln:virtualise:start-end:virtual-update}), control of the old
  funding output is handed over to $\texttt{host}_P$
  (Fig.~\ref{code:ln:virtualise:start-end},
  l.~\ref{code:ln:virtualise:start-end:host-me}), $\texttt{host}_P$ negotiates
  with its counterparty a new set of transactions and signatures that spend the
  aforementioned funding output and make available a new funding output with the
  keys that $P$ instructed (Fig.~\ref{code:virtual-layer:funder-sigs}
  and~\ref{code:virtual-layer:funding-sigs}) and the previous valid commitment
  transactions of both $P$ and $\bar{P}$ are invalidated
  (Fig.~\ref{code:ln:methods-for-virt},
  l.~\ref{code:ln:methods-for-virt:revoke-previous} and
  l.~\ref{code:ln:methods-for-virt:process-remote-revocation} respectively).
  When $P$ receives (\textsc{close}) by \environment, it inputs (\textsc{close})
  to $\texttt{host}_P$ (Fig.~\ref{code:ln:close}, l.~\ref{code:ln:close:relay}).
  If the \texttt{host} of $\texttt{host}_P$ is \ledger, then $\texttt{host}_P$
  either is able to publish its $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$
  (since it has necessarily received a valid $\mathrm{sig}_{\mathrm{loc},
  \mathrm{none}}$ (Fig.~\ref{code:virtual-layer:funding-sigs},
  l.~\ref{code:virtual-layer:funding-sigs:funder-verify}) by its counterparty
  before it moved to the \textsc{open} state for the first time), or the output
  needed to spend $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$ has already been
  spent. The only other transactions that can spend it are $\mathrm{TX}_{2,
  \mathrm{none}}$ and $\mathrm{TX}_{2, \mathrm{right}}$, since these are the
  only transactions that spend the aforementioned output and that
  $\texttt{host}_P$ has signed (Fig.~\ref{code:virtual-layer:funding-sigs},
  ll.~\ref{code:virtual-layer:funding-sigs:funder-sign-none}
  and~\ref{code:virtual-layer:funding-sigs:funder-sign-right}). The output can
  be also spent by old, revoked commitment transactions, but in that case
  $\texttt{host}_P$ would not have output (\textsc{closed}); $P$ would have
  instead detected this triggered by a (\textsc{check chain for closed}) message
  by \environment (Fig.~\ref{code:ln:poll}) and would have moved to the
  \textsc{closed} state on its own accord (lack of such a message by
  \environment would lead $P$ to become \texttt{negligent}, something that
  cannot happen according to the Lemma conditions). If
  $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$ ends up in \ledger, its
  \texttt{out} output (Fig.~\ref{code:virtual-layer:endpoint-txs},
  l.~\ref{code:virtual-layer:edge-txs:funder-out}) carries $c_P + c_{\bar{P}} -
  f$ coins and can be spent either by a timelocked $\texttt{"3"} \wedge
  2/\{\pk{P, F}', \pk{\bar{P}, F}'\}$ spending method or by a non-timelocked
  $\texttt{"1"} \wedge 4/\{\pk{P, F}', \pk{\bar{P}, F}', \pk{R, F}, \pk{\bar{R},
  F}\}$ spending method. The only transactions with an input having the latter
  spending method that $\texttt{host}_P$ has signed with $\sk{P, F}'$ are
  $\mathrm{TX}_{2, \mathrm{left}}$ and $\mathrm{TX}_{2, \mathrm{both}}$
  (Fig.~\ref{code:virtual-layer:funder-sigs}) and they both have a ($c_P +
  c_{\bar{P}} - f$, $\texttt{"3"} \wedge 2/\{\pk{P,F}', \pk{\bar{P},F}'\}$)
  output. Similarly, both $\mathrm{TX}_{2, \mathrm{none}}$ and $\mathrm{TX}_{2,
  \mathrm{right}}$ have an output with $c_P + c_{\bar{P}} - f$ coins that can be
  spent either by a timelocked $\texttt{"3"} \wedge 2/\{\pk{P,F}',
  \pk{\bar{P},F}'\}$ spending method or by a non-timelocked $\texttt{"2"} \wedge
  4/\{\pk{P, F}', \pk{\bar{P}, F}', \pk{R, F}, \pk{\bar{R}, F}\}$ spending
  method.  $\texttt{host}_P$ has never signed any transaction that can use the
  latter spending method, therefore the timelock will eventually expire. To sum
  up, in all cases a ($c_P + c_{\bar{P}} - f$, $\texttt{"3"} \wedge
  2/\{\pk{P,F}', \pk{\bar{P},F}'\}$) output will end up in \ledger. This output
  can be spent either by $C_{P, i}$ or $C_{\bar{P}, i}$.  Both these
  transactions have a $(c_P - f, \pk{P, \mathrm{out}})$ output. This output of
  $C_{P, i}$ is timelocked, but the alternative spending method cannot be used
  as $P$ never signed a transaction that uses it (as it is reserved for
  revocation, which has not taken place yet in this virtualisation layer).  By
  the induction hypothesis, before the funding procedure started $P$ could close
  the channel for an ($c_P$, $\pk{P, \mathrm{out}}$) output. We have now proven
  that if $P$ completes the funding of a new channel and it has $F = []$, then
  it can close its channel for a ($c_P - f$, $\pk{P, \mathrm{out}}$) output.
  Regarding the case that $F \neq []$, this means that before the funding
  procedure started $\texttt{host}_P \neq \ledger$. By the inductive hypothesis,
  $P$ could then close the channel for an ($c_P$, $\pk{P, \mathrm{out}}$)
  output. After the funding procedure is complete, the new $\texttt{host}_P$
  will have as its \texttt{host} the old $\texttt{host}_P$ of $P$. If the
  (\textsc{close}) sequence is initiated, the new $\texttt{host}_P$ will follow
  the same steps as before once the old $\texttt{host}_P$ succeeds in closing
  the lower layer (Fig.~\ref{code:virtual-layer:close},
  l.~\ref{code:virtual-layer:close:if-nested-host}). The old $\texttt{host}_P$
  however will see no difference in its intrerface than before, therefore it
  will successfully close by the induction hypothesis. Thereafter the process is
  identical to the one when the old $\texttt{host}_P = \ledger$. We have
  therefore proven the first claim of the first bullet.
\end{proof}

%\begin{proof}
%    Else if $\texttt{hops} \neq \ledger$, $P$ is able to cause an eventual
%    inclusion of a transaction with output $(c, 2/\{\pk{P, F}, \pk{\bar{P} ,
%    F}\})$ in the \ledger state by passing input (\textsc{close}) to
%    $\texttt{host}_P$ that results in $\texttt{host}_P$ outputting
%    (\textsc{closed}) -- we only examine the case where this output is indeed
%    given, as stipulated in the Lemma conditions.  The eventual transaction
%    output inclusion in \ledger is guaranteed due to the following:
%    \texttt{hops}[0].\texttt{left} (when $P = \alice$,
%    Fig.~\ref{code:ln:prepare-base}, l.~\ref{code:ln:prepare-base:fund-me}) or
%    \texttt{hops}[-1].\texttt{right} (when $P = \bob$, Fig.~\ref{code:ln:bob},
%    l.~\ref{code:ln:bob:funded}) has passed output (\textsc{funded}, $\dots$) to
%    $P$, as this party is trusted (as it executes locally) and has itself been
%    passed output (\textsc{hosts ready}) by its (also trusted) $\texttt{host}$
%    \textsc{virt} ITI (Fig.~\ref{code:ln:virtualise:start-end},
%    l.~\ref{code:ln:virtualise:start-end:hosts-ready}). The \texttt{host} only
%    outputs (\textsc{hosts ready}) when its \texttt{guest} (which is the
%    aforementioned party that outputs (\textsc{funded}, $\dots$)) verifies that
%    the remote revocation of the previous commitment transaction has happened
%    correctly (Fig.~\ref{code:virtual-layer:revocation},
%    ll.~\ref{code:virtual-layer:revocation:non-funder:proc-remote}
%    or~\ref{code:virtual-layer:revocation:funder:proc-remote}). Furthermore,
%    $\texttt{host}_P$ only outputs (\textsc{closed}) if there exists a suitable
%    transation output in \ledger (Fig.~\ref{code:virtual-layer:close},
%    l.~\ref{code:virtual-layer:close:when-closed}). If $\texttt{host}_P$ was
%    prompted to closure by $P$, then this transaction output is the desired one.
%    If $\texttt{host}_P$ hosts a party of another channel and that party
%    prompted a closure the desired transaction output will end up in \ledger as
%    well. The reason for that is because the only way any of the aforementioned
%    party can close honestly its channel is by publishing its copy of the only
%    valid transaction as per Fig.~\ref{code:virtual-layer:close},
%    l.~\ref{code:virtual-layer:close:tx}, which is the exact same transaction
%    that would be published had $P$ closed first. Since $P$ belongs to a newly
%    opened channel, there exist five different valid transactions that include
%    the desired output: $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$ held by
%    $\texttt{host}_P$ (Fig.~\ref{code:virtual-layer:fundee-sigs},
%    l.~\ref{code:virtual-layer:fundee-sigs:tx-none} if $P$ is fundee,
%    Fig.~\ref{code:virtual-layer:funder-sigs},
%    l.~\ref{code:virtual-layer:funder-sigs:tx-none} if $P$ is funder) and
%    $\mathrm{TX}_{\mathrm{prev}, \mathrm{none}}$, $\mathrm{TX}_{\mathrm{prev},
%    \mathrm{left}}$, $\mathrm{TX}_{\mathrm{prev}, \mathrm{right}}$,
%    $\mathrm{TX}_{\mathrm{prev}, \mathrm{both}}$ if $P$ is fundee or
%    $\mathrm{TX}_{\mathrm{next}, \mathrm{none}}$, $\mathrm{TX}_{\mathrm{next},
%    \mathrm{left}}$, $\mathrm{TX}_{\mathrm{next}, \mathrm{right}}$,
%    $\mathrm{TX}_{\mathrm{next}, \mathrm{both}}$ if $P$ is funder, held by
%    $\texttt{host}_{\bar{P}}$ (Fig.~\ref{code:virtual-layer:intermediary-sigs}).
%    We will here refer to the subscripts ``prev''/``next'' as ``other'' for
%    simplicity.  All valid combinations of these transactions in \ledger (only
%    $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$, only
%    $\mathrm{TX}_{\mathrm{other}, \mathrm{none}}$, only
%    $\mathrm{TX}_{\mathrm{other}, \mathrm{right}}$, $\mathrm{TX}_{\mathrm{loc},
%    \mathrm{none}}$ and $\mathrm{TX}_{\mathrm{other}, \mathrm{left}}$, or
%    $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$ and
%    $\mathrm{TX}_{\mathrm{other}, \mathrm{both}}$) eventually result in exactly
%    one output of interest in \ledger. Any other transaction that has the same
%    input as $\mathrm{TX}_{\mathrm{loc}, \mathrm{none}}$ is revoked before the
%    output (\textsc{funded}, $\dots$) to $P$ and therefore having any of these
%    transactions published instead would violate the aforementioned Lemma
%    condition.
%  \end{itemize}
%  Given that all of the aforementioned are true, before transitioning to the
%  \textsc{open} \textit{State}, $P$ has produced and sent only one valid signature for
%  the $(c, 2/\{\pk{P, F}, \pk{\bar{P}, F}\})$ output with $\sk{P, F}$, namely
%  for $C_{\bar{P}, 0}$ (Fig.~\ref{code:ln:exchange-open-sigs},
%  ll.~\ref{code:ln:exchange-open-sigs:a-sign}
%  or~\ref{code:ln:exchange-open-sigs:b-sign}), and sent it to $\bar{P}$
%  (Fig.~\ref{code:ln:exchange-open-sigs},
%  ll.~\ref{code:ln:exchange-open-sigs:a-send}
%  or~\ref{code:ln:exchange-open-sigs:b-send}), therefore the unique two ways to
%  spend $(c, 2/\{\pk{P, F}, \pk{\bar{P}, F}\})$ are by either publishing $C_{P,
%  0}$ or $C_{\bar{P}, 0}$. We observe that $C_{P, 0}$ has a ($g$, ($\pk{P,
%  \mathrm{out}} + (t + s)$) $\vee$ $2/\{\pk{P, R}, \pk{\bar{P}, R}\}$) output,
%  where $g = c$ if $P = \alice$ and $g = 0$ if $P = \bob$
%  (Fig.~\ref{code:ln:exchange-open-sigs},
%  l.~\ref{code:ln:exchange-open-sigs:a-tx}
%  or~\ref{code:ln:exchange-open-sigs:b-tx}). Since we assume $P$ is honest, it
%  will never give the opportunity for the spending method $2/\{\pk{P, R},
%  \pk{\bar{P}, R}\}$ to be used (as this corresponds to publishing a revoked
%  transaction), therefore the alternative spending method, $\pk{P, \mathrm{out}}
%  + (t + s)$, is the only one that will be spendable if $C_{P, 0}$ is included
%  in \ledger, therefore contributing $g$ to the sum of outputs that contribute
%  to inequality~\ref{lemma:real-balance-security:ineq}.  Likewise, if
%  $C_{\bar{P}, 0}$ is included in \ledger, it will contribute at least one ($g$,
%  $\pk{P, \mathrm{out}}$) output to this inequality, as $C_{\bar{P}, 0}$ has a
%  ($g$, $\pk{P, \mathrm{out}}$) output (Fig.~\ref{code:ln:exchange-open-sigs},
%  l.~\ref{code:ln:exchange-open-sigs:a-tx}
%  or~\ref{code:ln:exchange-open-sigs:b-tx}). We also observe that, if $n = m = l
%  = 0$, then the Lemma holds.
%
%    %sibling common tx justification
%    , or if $\texttt{host}_P$ has a \texttt{sibling} and the latter prompted a
%    closure,%
%    In particular for the case of \texttt{sibling}s, neither of the two
%    siblings outputs \textsc{hosts ready} before it knows that both their
%    counterparties have revoked properly
%    (Fig.~\ref{code:virtual-layer:revocation}).%
%    and the only valid transaction of each counterparty is one of
%    $\mathrm{TX}_{\mathrm{prev}, \mathrm{none}}$, $\mathrm{TX}_{\mathrm{prev},
%    \mathrm{left}}$, $\mathrm{TX}_{\mathrm{prev}, \mathrm{right}}$,
%    $\mathrm{TX}_{\mathrm{prev}, \mathrm{both}}$ if the counterparty is closer
%    than the local party to the fundee or $\mathrm{TX}_{\mathrm{next},
%    \mathrm{none}}$, $\mathrm{TX}_{\mathrm{next}, \mathrm{left}}$,
%    $\mathrm{TX}_{\mathrm{next}, \mathrm{right}}$, $\mathrm{TX}_{\mathrm{next},
%    \mathrm{both}}$ if the counterparty is closer than the local party to the
%    funder and all these transactions contain the output of interest.%
%\end{proof}
