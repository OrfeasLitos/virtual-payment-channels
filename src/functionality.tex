\TODO{Add support for cooperative adding multiple virtuals to single channel as
future work (needs cooperation by all hops of all existing virtuals of current
channel)}
\TODO{Add support for cooperative closing as future work}

\begin{figure}[H]
  \begin{systembox}{$\mathcal{F}_{\mathrm{Chan}}$ -- relay rules}
    \begin{itemize}
      \item Every input by \environment is first handled according to the
      corresponding rule in Fig~\ref{code:functionality:state-machine} (if any)
      and subsequently is sent to \adversary.
      \item Every message (\texttt{msg}, $P$, $R$, \texttt{mode}) by \adversary
      ($\texttt{mode} \in \{\mathrm{input}, \mathrm{output},
      \mathrm{message}\}$, $P \in \{A, B\}$) is first handled according to the
      corresponding rule in Fig~\ref{code:functionality:state-machine} (if any).
      Subsequently \texttt{msg} is relayed to $R$ as $P$ by means of
      \texttt{mode}.
    \end{itemize}
  \end{systembox}
  \caption{}
  \label{code:functionality:rules}
\end{figure}

\begin{figure}[H]
  \begin{systembox}{$\mathcal{F}_{\mathrm{Chan}}$ -- init, top up \& corruption}
    \begin{algorithmic}[1]
      \State On (\textsc{corrupt}) by $P$, addressed to \alice:
      \Indent
        \State ensure $P \in \{\texttt{host\_alice}, \adversary\}$
        \State $\texttt{virtual\_secrets} \gets \emptyset$
        \ForAll{$(\_, \_, (\mathrm{fundee}, \_), (\alice, \_), \textit{vid}) \in
        \mathtt{virtuals}$}
          \State send (\textsc{corrupt}) to fundee and ensure reply is
          (\textsc{corrupted}, \texttt{secrets})
          \State append (\texttt{secrets}, \textit{vid}) to
          \texttt{virtual\_secrets}
        \EndFor
        \State from now on, allow \adversary to handle all \alice's messages,
        i.e. act as a relay
        \If{\bob is not corrupted}
          \State from now on, handle all messages by \bob as \pchan
          (Fig.~\ref{code:protocol:chan:skeleton}-\ref{code:protocol:chan:skeleton:virtual})
        \EndIf
        \If{$P = \texttt{host\_alice}$}
          \State output (\textsc{corrupted}, (\textsc{ln.secrets}(\alice),
          \texttt{virtual\_secrets})) to \texttt{host\_alice}
        \Else \: \Comment{$P = \adversary$}
          \State send (\textsc{corrupted}, (\textsc{ln.secrets}(\alice),
          \texttt{virtual\_secrets})) to \adversary
        \EndIf
      \EndIndent
    \end{algorithmic}
  \end{systembox}
  \caption{}
  \label{code:functionality:chan:skeleton:init}
\end{figure}
