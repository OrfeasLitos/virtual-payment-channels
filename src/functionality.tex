\TODO{Add support for cooperative adding multiple virtuals to single channel as
future work (needs cooperation by all hops of all existing virtuals of current
channel)}
\TODO{Add support for cooperative closing as future work}

\begin{figure}[H]
  \begin{systembox}{$\mathcal{F}_{\mathrm{Chan}}$ -- init, top up \& corruption}
    \begin{algorithmic}[1]
      \State On (\textsc{corrupt}) by $P$, addressed to \alice:
      \Indent
        \State ensure $P \in \{\texttt{host\_alice}, \adversary\}$
        \State $\texttt{virtual\_secrets} \gets \emptyset$
        \ForAll{$(\_, \_, (\mathrm{fundee}, \_), (\alice, \_), \textit{vid}) \in
        \mathtt{virtuals}$}
          \State send (\textsc{corrupt}) to fundee and ensure reply is
          (\textsc{corrupted}, \texttt{secrets})
          \State append (\texttt{secrets}, \textit{vid}) to
          \texttt{virtual\_secrets}
        \EndFor
        \State from now on, allow \adversary to handle all \alice's messages,
        i.e. act as a relay
        \If{\bob is not corrupted}
          \State from now on, handle all messages by \bob as \pchan
          (Fig.~\ref{code:protocol:chan:skeleton}-\ref{code:protocol:chan:skeleton:virtual})
        \EndIf
        \If{$P = \texttt{host\_alice}$}
          \State output (\textsc{corrupted}, (\textsc{ln.secrets}(\alice),
          \texttt{virtual\_secrets})) to \texttt{host\_alice}
        \Else \: \Comment{$P = \adversary$}
          \State send (\textsc{corrupted}, (\textsc{ln.secrets}(\alice),
          \texttt{virtual\_secrets})) to \adversary
        \EndIf
      \EndIndent
    \end{algorithmic}
  \end{systembox}
  \caption{}
  \label{code:functionality:chan:skeleton:init}
\end{figure}

\begin{figure}[H]
  \begin{systembox}{$\mathcal{F}_{\mathrm{Chan}}$ -- base}
    \begin{algorithmic}[1]
      \State On (\textsc{balance}) by $\dave \in \{\alice, \bob\}$:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \label{code:functionality:chan:skeleton:base:balance:start}
        \State output (\textsc{balance}, $c_A, c_B, \mathrm{locked}(A),
        \mathrm{locked}(B)$) to \dave
        \label{code:functionality:chan:skeleton:base:balance:end}
      \EndIndent
    \end{algorithmic}
  \end{systembox}
  \caption{}
  \label{code:functionality:chan:skeleton:base}
\end{figure}
