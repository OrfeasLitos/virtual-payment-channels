\begin{figure}[H]
  \begin{protocolbox}{$\Pi_{\mathrm{Chan}}$}
    \begin{algorithmic}[1]
      \State Initialisation:
      \Indent
        \State $\mathit{State} \gets \textsc{init}$
      \EndIndent
      \Statex

      \State On \textsc{top up}, \textsc{check top up} by \environment, act as
      \fchan (Fig.~\ref{code:functionality:chan:skeleton:init},
      lines~\ref{code:functionality:chan:skeleton:init:top_up:start}-\ref{code:functionality:chan:skeleton:init:top_up:end}
      and~\ref{code:functionality:chan:skeleton:init:check_top_up:start}-\ref{code:functionality:chan:skeleton:init:check_top_up:end}
      respectively)
      \Statex

      \State On (\textsc{open}, $c_F$, $pk_{A, out}$, $pk_{B, out}$) by
      \environment:
      \Indent
        \State ensure $\mathit{State} = \textsc{topped up}$
        \State $\mathit{State} \gets \textsc{opening base channel}$
        \State do LN (other box) % TODO
      \EndIndent
      \Statex

      \State On (\textsc{check funding}) by \environment:
      \Indent
        \State ensure $\mathit{State} = \textsc{waiting for ledger}$
        \State send (\textsc{read}) to \ledger and assign reply to $\Sigma$
        \State ensure $F \in \Sigma$
        \State $c_A \gets c$; $c_B \gets 0$ \Comment{$c$ received in
        \textsc{open}}
        \State $\mathit{State} \gets \textsc{open base}$
        \State output (\textsc{open success}) to \environment
      \EndIndent
      \Statex

      \State On (\textsc{pay}, x) by \environment:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State ensure $c_A \geq x$
        \State do LN payment (these channels won't be async) (balance change
        here) % TODO
        \State output (\textsc{ok}) to \environment
      \EndIndent
      \Statex

      \State On (\textsc{balance}) by \environment:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State output (\textsc{balance}, $(c_A, c_B, \mathrm{locked}_A,
        \mathrm{locked}_B)$) to \environment \TODO{rethink locked}
      \EndIndent
      \Statex

      \State On (\textsc{close}) by \environment:
      \Indent
          \State $\mathrm{sig}_{A, C} \gets \textsc{sign}(C, sk_{A, F})$
          \Comment{$C$, $\mathrm{sig}_{B, C}$ received during last LN()}
        \If{$\mathit{State} = \textsc{open base}$}
          \State send (\textsc{submit}, $(C, \mathrm{sig}_{A, C},
          \mathrm{sig}_{B, C})$) to \ledger
        \ElsIf{$\mathit{State} = \textsc{open virtual}$}
          \State output (\textsc{close}, $(C, \mathrm{sig}_{A, C},
          \mathrm{sig}_{B, C})$) to \texttt{opener}
        \EndIf
      \EndIndent
    \end{algorithmic}
  \end{protocolbox}
  \caption{}
  \label{code:protocol:chan:skeleton}
\end{figure}

\begin{figure}[H]
  \begin{protocolbox}{$\Pi_{\mathrm{Chan}}$ -- virtual}
    \begin{algorithmic}[1]
      \State \Comment{notification to fundee}
      \State \Comment{trust that \alice has $c$ in her channel}
      \State On input (\textsc{fund you}, $c$, \bob, \texttt{outer\_peer}) by \charlie:
      \label{code:protocol:chan:skeleton:vchan:fund-you}
      \Indent
        \State ensure $\mathit{State} = \textsc{init}$
        \State $\mathit{State} \gets \textsc{opening virtual channel}$
        \label{code:protocol:chan:skeleton:vchan:fund-you:state}
        \State do LN with \bob{}, also send him his ``opener'' (our outer peer) -- TODO
        \label{code:protocol:chan:skeleton:vchan:ln}
        \State $\mathtt{opener} \gets \charlie$
        \State from now on, handle any (\textsc{relayed}, $m$) input by
        \texttt{opener} as the input ($m$) by \environment
        \State from now on, transform any output ($m$) to \environment to
        output (\textsc{relay}, $m$) to \texttt{opener}
        \State $\mathit{State} \gets \textsc{open virtual}$
        \State output (\textsc{ok}) to \charlie
        \label{code:protocol:chan:skeleton:vchan:fund-you:output}
      \EndIndent
      \Statex

      \State On (\textsc{fund}, $c$, hops, \texttt{sub\_parties} = (fundee,
      counterparty), \texttt{outer\_parties} = (\alice, \dave),
      $pk_{\mathit{VA}, out}$, $pk_{\mathit{VB}, out}$) by
      \environment:
      \Indent
        \State do the same as in \fchan,
        Fig.~\ref{code:functionality:chan:skeleton:virtual},
        lines~\ref{code:functionality:chan:skeleton:virtual:fund}-\ref{code:functionality:chan:skeleton:virtual:fund:for:allow:end},
        skipping line~\ref{code:functionality:chan:skeleton:virtual:fund:leak}
        \Comment{``as \alice'' sender labels are applied anyway, since we
        \emph{are} \alice}
        \State do VChan() with hops -- TODO \Comment{$P_{i-1} P_i, P_i P_{i+1}$
        and all $P_1 P_n$ held by BOTH $R_{i-1}$ and $L_i$. $P_{i-1} P_i$ held
        only by $R_{i-1}$, $P_i P_{i+1}$ held only by $L_i$. This (probably)
        ensures that only relevant parties can close their channels (with the
        exception of honest $R_{i-1}$ wanting to leave channels virtual but
        corrupted $L_i$ demoting them to base, which however doesn't cost funds
        to anyone), but that they have minimal impact to the decisions of
        ajdacent channels. All $P_{i-1} P_i$ inputs must be signed by $R_{i-1}$
        and all $P_i P_{i+1}$ inputs by $L_i$.}
        \label{code:protocol:chan:skeleton:vchan}
        \State do the same as in \fchan,
        Fig.~\ref{code:functionality:chan:skeleton:virtual},
        lines~\ref{code:functionality:chan:skeleton:virtual:fund:confirm}-\ref{code:functionality:chan:skeleton:virtual:fund:store}
        \State output (\textsc{ok}) to \environment
      \EndIndent
      \Statex

      \State \Comment{notification to hop that locks coins}
      \State On (\textsc{allow fund}, $c$, \texttt{sub\_parties},
      \texttt{next\_hop}, id, \texttt{is\_last}) by \charlie:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State ensure $c_A - \mathrm{locked}_A \geq c$ \TODO{rethink locked}
        \State ensure \bob belongs to the same group as \texttt{next\_hop}
        \State output received message to \dave and ensure reply is
        \textsc{(ok)}
        \State send (\textsc{allow fund}, $c$, \texttt{sub\_parties},
        \texttt{next\_hop}, id, \texttt{is\_last}, \charlie) to \bob and ensure
        reply is (\textsc{ok})
        \State $\mathrm{locked}_A \gets \mathrm{locked}_A + c$
        \State add (id, \texttt{is\_last}, \texttt{sub\_parties}, $c$,
        \textsc{we lock}) to \texttt{pending}
        \State send (\textsc{ok}) to \charlie
      \EndIndent
      \Statex

      \State \Comment{notification to hop that doesn't lock coins -- doesn't ask
      \environment}
      \State On (\textsc{allow fund}, $c$, \texttt{sub\_parties},
      \texttt{next\_hop}, id, \texttt{is\_last}, \charlie) by \bob:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State ensure $c_A - \mathrm{locked}_A \geq c$ \TODO{rethink locked}
        \State ensure we belong to the same group as \texttt{next\_hop}
        \State add (id, \texttt{is\_last}, \texttt{sub\_parties}, $c$,
        \textsc{we don't lock}) to \texttt{pending}
        \State send (\textsc{ok}) to \bob
      \EndIndent
      \Statex

      \State On (\textsc{close}, $(C, \mathrm{sig}_{A, C}, \mathrm{sig}_{B,
      C})$) output by \charlie:
      \Indent
        \State TODO: check virtual, save comm, change virtual state
      \EndIndent
      \Statex

      \State On (\textsc{relay}, $m$, \charlie) by \environment:
      \Indent
        \State do the same as in \fchan,
        Fig.~\ref{code:functionality:chan:skeleton:virtual},
        lines~\ref{code:functionality:chan:skeleton:virtual:relay:input:start}-\ref{code:functionality:chan:skeleton:virtual:relay:input:end}
      \EndIndent
      \Statex

      \State On output (\textsc{relay}, $m$) by \charlie:
      \Indent
        \State do the same as in \fchan,
        Fig.~\ref{code:functionality:chan:skeleton:virtual},
        lines~\ref{code:functionality:chan:skeleton:virtual:relay:output:start}-\ref{code:functionality:chan:skeleton:virtual:relay:output:end}
      \EndIndent
      \TODO{check that everything done in ideal wrt closing is also done here}
    \end{algorithmic}
  \end{protocolbox}
  \caption{}
  \label{code:protocol:chan:skeleton:virtual}
\end{figure}
