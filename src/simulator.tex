\begin{figure}[H]
  \begin{simulatorbox}{\simulator}
    \begin{algorithmic}[1]
      \State On $(\textsc{open}, c_F, pk_{A, \mathrm{out}}, pk_{B,
      \mathrm{out}}, F, \mathrm{sig}_F \alice)$ by \fchan: \Comment{both honest}
      \Indent
        \State simulate \alice receiving input $(\textsc{open}, c_F, pk_{A,
        \mathrm{out}}, pk_{B, \mathrm{out}})$ by \environment
        \State ensure simulated \alice sends (\textsc{submit}, $(F',
        \mathrm{sig}_{F'})$) to \ledger
        \State send (\textsc{submit}, $(F, \mathrm{sig}_F)$) to \ledger
      \EndIndent
      \Statex

      \State On $(\textsc{open}, c_F, pk_{A, \mathrm{out}}, pk_{B,
      \mathrm{out}}, pk_{B, F}, \bob)$ by \fchan: \Comment{\alice corrupted}
      \Indent
        \State send LN message (\textsc{open}, $pk_{B, F}$) to \alice and relay
        reply to \fchan \TODO{change msg to fit LN, ensure \alice doesn't see a
        difference from real world}
      \EndIndent
      \Statex

      \State On (\textsc{pay}, $x$, \dave) by \fchan:
      \Indent
        \State simulate \dave receiving input (\textsc{pay}, $x$) by \environment
        \State ensure simulated \dave outputs (\textsc{ok})
        \State send (\textsc{ok}) to \fchan
      \EndIndent
      \Statex

      \State On (\textsc{fund you}, $c$, \bob, \charlie, \alice) by \fchan:
      \Indent
        \State simulate \alice receiving input (\textsc{fund you}, $c$, \bob) by
        \charlie
        \State ensure simulated \alice outputs (\textsc{ok}) to \charlie
        \State send (\textsc{ok}) to \fchan
      \EndIndent
      \Statex

      \State On (\textsc{fund} $c$, hops, \texttt{sub\_parties} = (fundee,
      counterparty), \texttt{outer\_parties} = (\charlie, \dave),
      \texttt{funder} = \alice, id) by \fchan:
      \label{code:simulator:fund}
      \Indent
        \State add the message data to \texttt{virtual\_opening}
        \State simulate execution of
        line~\ref{code:functionality:chan:skeleton:virtual:fund:init} of
        Fig.~\ref{code:functionality:chan:skeleton:virtual} with \alice
        \Comment{\simulator knows \bob (\alice's counterparty) through opening
        procedure}
        \State send (\textsc{ok}) to \fchan
        \label{code:simulator:fund:ok}
      \EndIndent
      \Statex

      \State On (\textsc{allow fund}, $c$, \texttt{sub\_parties},
      \texttt{local\_funder} = $L_i$, id, $i \overset{?}{=} |\mathrm{hops}|$) by
      \fchan's \alice to \charlie:
      \Indent
        \State simulate receiving message with \charlie by \alice and all
        subsequent communication
        \State ensure the simulated \charlie sends (\textsc{ok}) to the
        simulated \alice
        \State intercept this message and send it to \fchan's \alice
      \EndIndent
      \Statex

      \State On (\textsc{is open successful}, id) by \fchan:
      \Indent
        \State retrieve and remove from \texttt{virtual\_opening} the data
        marked with id
        \State simulate line~\ref{code:protocol:chan:skeleton:vchan} of
        Fig.~\ref{code:protocol:chan:skeleton:virtual} with \alice using this
        data
        \State ensure \alice completes execution of VChan() successfully
        \State send (\textsc{ok}) to \fchan
      \EndIndent
      \Statex

      \State On (\textsc{fund done}, id) by \fchan's \alice to \charlie:
      \Indent
        \State simulate receiving message with \charlie by \alice and all
        subsequent communication
        \State ensure the simulated \charlie sends (\textsc{ok}) to the
        simulated \alice
        \State intercept this message and send it to \fchan's \alice
      \EndIndent
    \end{algorithmic}
  \end{simulatorbox}
  \caption{}
  \label{code:simulator}
\end{figure}
