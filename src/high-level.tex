\section{Protocol Description}
  Conceptually, Elmo is split into four main actions: channel opening,
  payments, cooperative closing and unilateral closing. A channel $(P_1, P_n)$
  between parties $P_1$ and $P_n$
  may be opened directly on-chain, in which case the two parties follow an
  opening procedure similar to that of LN; such a channel is called
  \emph{simple}.
  Otherwise it can be opened on top of a path
  of preexisting \emph{base} channels $(P_1, P_2)$, $(P_2, P_3)$, $\dots$,
  $(P_{n-1}, P_{n})$, in which case $(P_1, P_n)$ is a \emph{virtual}
  channel (since Elmo is recursive, each base channel may itself be simple or
  virtual). To open a virtual
  channel, all parties $P_i$ on the
  path follow our novel protocol, setting aside funds in their channels as
  collateral for the new virtual channel; this is done
  by creating so-called \emph{virtual} transactions that essentially
  tie the spending of two adjacent base channels into a single atomic action.
  Once intermediaries are done, a special \emph{funding} output has been
  created off-chain which carries the sum of $P_1$ and $P_n$'s channel
  balance. $P_1$ and $P_n$
  finally create the channel, applying a logic similar to LN on top of
  the funding output: their channel is now open. LN demands that the funding
  output is on-chain, but we lift this requirement. We instead guarantee that
  either endpoint can put the funding output put on-chain unilaterally.

  A payment over an established channel follows a procedure heavily inspired by
  LN as well. To be completed, a payment needs three messages to be exchanged by
  the two parties.

  A virtual channel can be optimistically closed completely off-chain. At a high
  level, the parties that control the base channels \emph{revoke} their \emph{virtual}
  transactions and the related \emph{commitment} transactions. Revoked transactions
  cannot be used anymore. This effectively ``peels'' one layer of virtualisation.
  Balances are redistributed so that intermediaries ``break even'', while $P_1$
  and $P_n$ each gets its rightful coins (as reflected in the last state of the
  virtual channel) in its base channel ($(P_1, P_2)$ and $(P_{n-1}, P_n)$
  respectively).

  Finally, the unilateral closing procedure of a virtual channel $(P_1, P_n)$
  does not need cooperation and consists of signing and publishing a number of
  transactions on-chain. In the simplest case, one of the two endpoints, say
  $P_1$, publishes her virtual transaction. This prompts $P_2$ to publish her
  virtual transaction as well and so on up to $P_{n-1}$, at which point the
  funding output of $(P_1, P_n)$ is automatically on-chain and closing can
  proceed as in LN. If instead any intermediary stays inactive, then a timelock
  expires and a suitable output becomes the funding output for $(P_1, P_n)$, at
  the expense of the inactive party.

  In a nutshell, a virtual channel is built on top of two or more \emph{base
  channels}, which, due to the recursive property, may themselves be simple or
  virtual. The parties that control the base channels are called \emph{base
  parties}. The fact that more than two base channels can be used by a
  virtual channel is ensured by the variadic property.

  As we mentioned earlier, a channel with its funding transaction on-chain is
  called \emph{simple}. A channel is either simple or virtual, not both. At a
  high level, during the channel opening procedure (c.f.\
  Figure~\ref{code:ln:open}) the two counterparties (i) create new keypairs and
  exchange the resulting public keys ($2$ messages), then (ii) if the channel is
  virtual, prepare the underlying base channels ($12 \cdot (n-1)$ total
  messages, i.e., $6$ outgoing messages per endpoint and $12$ outgoing messages
  per intermediary, for $n-2$ intermediaries), next (iii) they exchange
  signatures for their respective initial commitment transactions ($2$ messages)
  and lastly, (iv) if the channel is simple, the \emph{funder} signs and
  publishes the \emph{funding} transaction to the ledger. We note that like LN,
  only one of the two parties, the funder, provides coins for a new channel.
  This limitation simplifies the execution model and analysis, but can be lifted
  at the cost of additional protocol complexity.

  \begin{figure}
    \centering
    \subimport{./figures/manual-tikz/}{payment-layer-simple.tex}
    \caption{Funding, commitment and revocation transactions}
    \label{figure:payment-layer-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{virtual-layer-endpoint-simple.tex}
    \caption{$A-E$ virtual channel: $A$'s initiator transaction. Spends the
    funding output of the $A-B$ channel. Can be used if $B$ has not published
    a virtual transaction yet.}
    \label{figure:virtual-layer-endpoint-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-initiator-simple.tex}
    \caption{$A-E$ virtual channel: $B$'s initiator transaction. Spends the
    funding outputs of the $A-B$ and $B-C$ channels. Can be used if neither
    $A$ nor $C$ have published a virtual transaction yet.}
    \label{figure:virtual-layer-initiator-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-extend-interval-simple.tex}
    \caption{$A-E$ virtual channel: One of $B$'s extend interval
    transactions. $\sigma$ is the signature. Spends the virtual output of $A$'s
    initiator transaction and the funding output of the $B$-$C$ channel. Can be
    used if $A$ has already published its initiator transaction and $C$ has not
    published a virtual transaction yet.}
    \label{figure:virtual-layer-extend-interval-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-merge-intervals-simple.tex}
    \caption{$A$--$E$ virtual channel: One of $B$'s merge intervals
    transactions. Spends the virtual outputs of $A$'s and $C$'s virtual
    transactions. Usable if both $A$ and $C$ have already published their
    initiator transactions.}
    \label{figure:virtual-layer-merge-intervals-simple}
  \end{figure}

  \begin{figure*}
    \subimport{./figures/manual-tikz/}{example-start-end-simple.tex}
    \caption{$4$ simple channels supporting a virtual. $A$ starts closing
    by publishing its initiator tx, then parties $B$--$D$ each
    publishes its extend-interval tx with the relevant interval. No party is
    negligent. Virtual outputs are marked with their interval.}
    \label{figure:example-start-end-simple}
  \end{figure*}

