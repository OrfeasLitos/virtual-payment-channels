% TODO: decide whether to merge the two tables, having only 3 parties for BCVC
% and only n parties for the rest
\section{Efficiency Evaluation}
  \label{section:comparison}
  We offer here a comparison of this work with
  LVPC~\cite{10.1007/978-3-030-65411-5_18}, BCVC~\cite{cryptoeprint:2020:554}
  and Donner~\cite{donner} in terms of communication efficiency when opening and
  updating aggregated for all parties \TODO{decide on previous}. We also compare
  the maximum on-chain cost for an endpoint to unilaterally close its virtual
  channel. Furthermore, we compare the maximum on-chain cost for an intermediary
  to close its base channel. In order to only show the costs caused by
  supporting a virtual channel, we subtract the cost the intermediary would pay
  to close its channel if it was not supporting any virtual channel. Lastly, we
  compare the maximum total on-chain cost, aggregated over all parties. On-chain
  cost is measured in terms of size\footnote{Transaction size is calculated in
  so-called ``virtual bytes'', which map directly to on-chain fees and thus are
  preferred to raw bytes. We used the tool found in
  \url{https://jlopp.github.io/bitcoin-transaction-size-calculator/} to aid size
  calculation.} and number of transactions. The comparison is performed both for
  channels of length $2$ and for channels of length $n$. In the second
  comparison BCVC is not included, since only LVPC and Donner offer a way to
  open virtual channels of length greater than $2$ (since LVPC is recursive and
  Donner is variadic). For a virtual channel between $P_1$ and $P_n$ over $n-1$
  base channels via LVPC, we consider the case in which the funder $P_1$
  initially has a channel with $P_2$ and then opens one virtual channel with
  party $P_i$ on top of its channel with party $P_{i-1}$ for $i \in \{3, \dots,
  n\}$. We choose this topology, as $P_1$ cannot assume that there exist any
  virtual channels between other parties (which could be used as shortcuts).

  BCVC proposes $4$ configurations, each with different efficiency
  characteristics: over Generalised Channels~\cite{cryptoeprint:2020:476} (GC)
  or Lightning, and with or without validity (V or NV respectively); we include
  all of them here. We refer the reader to~\cite{cryptoeprint:2020:554} for more
  details.

  Some results disagree with those of the tables found in related work, due to
  differences in the counting method.

% TODO: stress that we here compare the _variadic_ Elmo construction
  \begin{table*}
    \caption{Efficiency comparison of virtual channel protocols with $3$
    parties}
    \label{table:comparison:overhead:3-parties}
    \begin{minipage}{\textwidth}
    \begin{center}
    \begin{tabular}{|l|c|c|c|c|c|c|}
    \hline
              & \multicolumn{2}{|c|}{Open} & \multicolumn{2}{|c|}{Update} &
              \multicolumn{2}{|c|}{Close} \\
    \hline
              & \#txs & size & \#txs & size & \#txs & size \\
    \hline
    LVPC       & 14 & 100000 & 2 & 100000 & 10 & 100000 \\
    \hline
    BCVC-GC-NV
              & 7 & 2829 & 2 & 695 & 7 & 2829 \\
    \hline
    BCVC-GC-V & 8 & 2803 & 2 & 695 & 6 & 2108 \\
    \hline
    BCVC-LN-NV
              & 16 & 7704 & 8 & 2824 & 3 & 1800 \\
    \hline
    BCVC-LN-V & 14 & 5722 & 4 & 1412 & 4 & 1778 \\
    \hline
    Donner    & 14 & 4721 & 2 & 695 & 10 & 3438 \\
    \hline
    this work & 1000 & 100000 & 1000 & 100000 & 1000 & 100000 \\
    \hline
    \end{tabular}
    \end{center}
    \end{minipage}
  \end{table*}

  \begin{table*}
    \caption{Open and Update efficiency comparison of virtual channel protocols
    with $n$ parties}
    \label{table:comparison:overhead:n-parties}
    \begin{minipage}{\textwidth}
    \begin{center}
    \begin{tabular}{|l|c|c|c|c|}
    \hline
              & \multicolumn{2}{|c|}{Open} & \multicolumn{2}{|c|}{Update} \\
    \hline
              & \multicolumn{2}{|c|}{TODO} & \multicolumn{2}{|c|}{TODO} \\
    \hline
              & \#txs & size & \#txs & size \\
    \hline
    LVPC      & $7(n-1)$ & $34n^2+1240n+695$ & $2$ & $695$ \\
    \hline
    Donner    & $4n-2$ & 100000 & $2$ & 100000 \\
    \hline
    Elmo      & 1000 & 100000 & 1000 & 100000 \\
    \hline
    \end{tabular}
    \end{center}
    \end{minipage}
  \end{table*}

  \begin{table*}
    \caption{On-chain worst case closing efficiency comparison of virtual
    channel protocols with $n$ parties}
    \label{table:comparison:overhead:n-parties:close}
    \begin{minipage}{\textwidth}
    \begin{center}
    \begin{tabular}{|l|c|c|c|c|c|c|c|c|}
    \hline
              \multicolumn{9}{|c|}{Close} \\
    \hline
              & \multicolumn{2}{|c|}{intermediary} &
              \multicolumn{2}{|c|}{funder} & \multicolumn{2}{|c|}{fundee} &
              \multicolumn{2}{|c|}{total} \\
    \hline
              & \#txs & size & \#txs & size & \#txs & size & \#txs & size \\
    \hline
    LVPC      & $3$ & $626.25$ & $2$ & $383$ & $2$ & $359$ & $2n-2$ & $434.75n -
              510.5$ \\
    \hline
    Donner    & $1$ & $204.5$ & $4$ & $704 + 43n$ & $1$ & $136.5$ & $2n$ & $458n
              - 26$ \\
    \hline
    Elmo      & $1$ & $263.75 + 26.75n$ & $2$ & $371$ & $2$ & $371$ & $n$ &
              \begin{tabular}{@{}c@{}}$26.75n^2 + 210.25n$ \\ $-
              156.5$\end{tabular} \\
    \hline
    \end{tabular}
    \end{center}
    \end{minipage}
  \end{table*}
  The on-chain number of transactions to close a virtual channel in the case of
  LVPC is calculated as follows: One ``split'' transaction is needed for each
  base channel ($n-1$ in total), plus one ``merge'' transaction per virtual
  channel ($n-2$ in total), plus a single ``refund'' transaction for the virtual
  channel, for a total of $2n-2$ transactions.

  We note that the linear size factor when the intermediary closes can, in the
  case of our work, be eliminated with the aid of Schnorr signatures (recently
  made available on Bitcoin). This is so because the $n$ signatures that are
  needed to spend each virtual output can be shrunk down to a single aggregate
  signature without compromising security. For the same reason, Schnorr
  signatures help eliminate the quadratic term and reduce the linear term of the
  total on-chain cost. The same cannot be said for the linear factor in Donner,
  since there is currently no way to optimise away the $n$ outputs of the
  funder's transaction $\tx^{\mathtt{vc}}$.
