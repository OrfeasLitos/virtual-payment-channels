\section{Protocol Description}
  Conceptually, Elmo is split into four main actions: channel opening,
  payments, cooperative closing and unilateral closing. A channel $(P_1, P_n)$
  between parties $P_1$ and $P_n$
  may be opened directly on-chain, in which case the two parties follow an
  opening procedure similar to that of LN; such a channel is called
  \emph{simple}.
  Otherwise it can be opened on top of a path
  of preexisting \emph{base} channels $(P_1, P_2)$, $(P_2, P_3)$, $\dots$,
  $(P_{n-1}, P_{n})$, in which case $(P_1, P_n)$ is a \emph{virtual}
  channel (since Elmo is recursive, each base channel may itself be simple or
  virtual). To open a virtual
  channel, all parties $P_i$ on the
  path follow our novel protocol, setting aside funds in their channels as
  collateral for the new virtual channel; this is done
  by creating so-called \emph{virtual} transactions that essentially
  tie the spending of two adjacent base channels into a single atomic action.
  Once intermediaries are done, a special \emph{funding} output has been
  created off-chain which carries the sum of $P_1$ and $P_n$'s channel
  balance. $P_1$ and $P_n$
  finally create the channel, applying a logic similar to LN on top of
  the funding output: their channel is now open. LN demands that the funding
  output is on-chain, but we lift this requirement. We instead guarantee that
  either endpoint can put the funding output put on-chain unilaterally.

  A payment over an established channel follows a procedure heavily inspired by
  LN as well. To be completed, a payment needs three messages to be exchanged by
  the two parties.

  A virtual channel can be optimistically closed completely off-chain. At a high
  level, the parties that control the base channels \emph{revoke} their \emph{virtual}
  transactions and the related \emph{commitment} transactions. Revoked transactions
  cannot be used anymore. This effectively ``peels'' one layer of virtualisation.
  Balances are redistributed so that intermediaries ``break even'', while $P_1$
  and $P_n$ each gets its rightful coins (as reflected in the last state of the
  virtual channel) in its base channel ($(P_1, P_2)$ and $(P_{n-1}, P_n)$
  respectively).

  Finally, the unilateral closing procedure of a virtual channel $(P_1, P_n)$
  does not need cooperation and consists of signing and publishing a number of
  transactions on-chain. In the simplest case, one of the two endpoints, say
  $P_1$, publishes her virtual transaction. This prompts $P_2$ to publish her
  virtual transaction as well and so on up to $P_{n-1}$, at which point the
  funding output of $(P_1, P_n)$ is automatically on-chain and closing can
  proceed as in LN. If instead any intermediary stays inactive, then a timelock
  expires and a suitable output becomes the funding output for $(P_1, P_n)$, at
  the expense of the inactive party.

  In a nutshell, a virtual channel is built on top of two or more \emph{base
  channels}, which, due to the recursive property, may themselves be simple or
  virtual. The parties that control the base channels are called \emph{base
  parties}. The fact that more than two base channels can be used by a
  virtual channel is ensured by the variadic property.

  As we mentioned earlier, a channel with its funding transaction on-chain is
  called \emph{simple}. A channel is either simple or virtual, not both. At a
  high level, during the channel opening procedure (c.f.\
  Figure~\ref{code:ln:open}) the two counterparties (i) create new keypairs and
  exchange the resulting public keys ($2$ messages), then (ii) if the channel is
  virtual, prepare the underlying base channels ($12 \cdot (n-1)$ total
  messages, i.e., $6$ outgoing messages per endpoint and $12$ outgoing messages
  per intermediary, for $n-2$ intermediaries), next (iii) they exchange
  signatures for their respective initial commitment transactions ($2$ messages)
  and lastly, (iv) if the channel is simple, the \emph{funder} signs and
  publishes the \emph{funding} transaction to the ledger. We note that like LN,
  only one of the two parties, the funder, provides coins for a new channel.
  This limitation simplifies the execution model and analysis, but can be lifted
  at the cost of additional protocol complexity.

  In order to build better intuition for Elmo, let us present examples of the
  lifecycles of a simple and a virtual channel. Consider $5$ parties, $A, B,
  \dots, E$ and $4$ channels, $(A, B)$, $\dots,(D, E)$, that will act as
  the base of the virtual channel $(A, E)$. We first follow the operations of
  the simple channel $(A, B)$ and then those of $(A, E)$. We simplify some parts
  of the protocol to aid comprehension.

  \makeatletter%
  \@ifclassloaded{IEEEtran}%
    {\paragraph{Simple channel}}%
    {\paragraph{Simple channel.}}%
  \makeatother%
  First $A$ and $B$ generate keypairs and exchange the public keys. Each then
  locally generates the \emph{funding} and the two \emph{commitment} txs
  (Fig.~\ref{figure:payment-layer-simple}). The latter are signed and the
  signatures are exchanged. $A$ then publishes the funding tx on-chain. Once it
  is finalised, the channel is open.

  The funding tx moves $A$'s initial coins to a $2$-of-$2$ multisig, i.e., an
  output that needs signatures from both $A$ and $B$ to be spent. There is one
  commitment tx per party, stored locally off-chain. The one held by $A$
  ($C_{A,i}$ in Fig.~\ref{figure:payment-layer-simple}) spends the funding tx
  and has one output for $A$ (initially with all coins) and one for $B$
  (initially with $0$ coins). $A$'s output can be spent by either a multisig, or
  by $A$ after a relative timelock of $t$. This is, as we will promptly see, so
  that $B$ has some time to \emph{punish} $A$ if she cheats. $B$'s commitment tx
  is symmetric.

  When $A$ pays $B$, the parties create new commitment txs reflecting the new
  balance, sign them and exchange the signatures. In order to ensure only one
  set of commitment txs is valid at a time, they then revoke their previous
  commitment txs. This is done by generating and signing the revocation txs of
  the previous commitment txs. $B$'s revocation tx ($R_{B,i}$ in
  Fig.~\ref{figure:payment-layer-simple}) gives to $B$ the coins that belonged
  to $A$ in the previous commitment tx and vice versa. This way both parties are
  disincentivised from publishing an old commitment tx under the threat of
  losing all their channel coins.

  Closing $(A, B)$ is now as simple as unilaterally publishing the latest
  commitment tx on-chain and waiting for the timelock to expire. Since the last
  commitment tx is not revoked, punishment is impossible. Observe that the
  mechanics of simple channels are essentially a simplification of LN.

  \begin{figure}
    \centering
    \subimport{./figures/manual-tikz/}{payment-layer-simple.tex}
    \caption{Funding, commitment and revocation transactions}
    \label{figure:payment-layer-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{virtual-layer-endpoint-simple.tex}
    \caption{$A-E$ virtual channel: $A$'s initiator transaction. Spends the
    funding output of the $A-B$ channel. Can be used if $B$ has not published
    a virtual transaction yet.}
    \label{figure:virtual-layer-endpoint-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-initiator-simple.tex}
    \caption{$A-E$ virtual channel: $B$'s initiator transaction. Spends the
    funding outputs of the $A-B$ and $B-C$ channels. Can be used if neither
    $A$ nor $C$ have published a virtual transaction yet.}
    \label{figure:virtual-layer-initiator-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-extend-interval-simple.tex}
    \caption{$A-E$ virtual channel: One of $B$'s extend interval
    transactions. Spends the virtual output of $A$'s
    initiator transaction and the funding output of the $B$-$C$ channel. Can be
    used if $A$ has already published its initiator transaction and $C$ has not
    published a virtual transaction yet.}
    \label{figure:virtual-layer-extend-interval-simple}
  \end{figure}

  \begin{figure}
    \subimport{./figures/manual-tikz/}{intermediary-merge-intervals-simple.tex}
    \caption{$A$--$E$ virtual channel: One of $B$'s merge intervals
    transactions. Spends the virtual outputs of $A$'s and $C$'s virtual
    transactions. Usable if both $A$ and $C$ have already published their
    initiator or extend-interval transactions.}
    \label{figure:virtual-layer-merge-intervals-simple}
  \end{figure}

  \begin{figure*}
    \subimport{./figures/manual-tikz/}{example-start-end-simple.tex}
    \caption{$4$ simple channels supporting a virtual. $A$ starts closing by
    publishing its initiator tx, then parties $B$--$D$ each publishes its
    extend-interval tx with the relevant interval. No party stays inactive.
    Virtual outputs are marked with their interval. \emph{Bridge} txs
    (such as $b$) are needed to convert the various virtual outputs into the
    same funding output, as \texttt{ANYPREVOUT} only works across identical
    outputs.}
    \label{figure:example-start-end-simple}
  \end{figure*}

