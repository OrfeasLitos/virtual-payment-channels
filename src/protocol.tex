\begin{figure}[H]
  \begin{protocolbox}{$\Pi_{\mathrm{Chan}}$}
    \begin{algorithmic}[1]
      \State Initialisation:
      \Indent
        \State $\mathit{State} \gets \textsc{init}$
      \EndIndent
      \Statex

      \State On (\textsc{open}, $c$, \texttt{tx\_out}, $sk$, $pk_{A, out}$,
      $pk_{B, out}$) by \environment:
      \Indent
        \State ensure $\mathit{State} = \textsc{init}$
        \State $\mathit{State} \gets \textsc{opening base channel}$
        \State do LN (other box) % TODO
      \EndIndent
      \Statex

      \State On (\textsc{check}) by \environment:
      \Indent
        \State ensure $\mathit{State} = \textsc{waiting for ledger}$
        \State send (\textsc{read}) to \ledger and assign reply to $\Sigma$
        \State ensure $F \in \Sigma$
        \State $c_A \gets c$; $c_B \gets 0$ \Comment{$c$ received in
        \textsc{open}}
        \State $\mathit{State} \gets \textsc{open base}$
        \State output (\textsc{open success}) to \environment
      \EndIndent
      \Statex

      \State On (\textsc{pay}, x) by \environment:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State ensure $c_A \geq x$
        \State do LN payment (these channels won't be async) (balance change
        here) % TODO
        \State output (\textsc{ok}) to \environment
      \EndIndent
      \Statex

      \State On (\textsc{balance}) by \environment:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State output (\textsc{balance}, $(c_A, c_B, \mathrm{locked}_A,
        \mathrm{locked}_B)$) to \environment % TODO: maybe remove locked_{A,B}
      \EndIndent
      \Statex

      \State On (\textsc{close}) by \environment:
      \Indent
        \If{$\mathit{State} = \textsc{open base}$}
          \State prepare $C$ TODO
          \State send (\textsc{submit}, $C$) to \ledger
        \ElsIf{$\mathit{State} = \textsc{open virtual}$}
          \State TODO
        \EndIf
      \EndIndent
    \end{algorithmic}
  \end{protocolbox}
  \caption{}
  \label{code:protocol:chan:skeleton}
\end{figure}

\begin{figure}[H]
  \begin{protocolbox}{$\Pi_{\mathrm{Chan}}$ -- virtual}
    \begin{algorithmic}[1]
      \State \Comment{notification to funder}
      \State \Comment{trust that \alice has $c$ in her channel}
      \State On (\textsc{fund you}, $c$, \bob) by \charlie as input:
      \Indent
        \State ensure $\mathit{State} = \textsc{init}$
        \State $\mathit{State} \gets \textsc{opening virtual channel}$
        \State do LN with \bob{} -- TODO
        \State output (\textsc{ok}) to \charlie
      \EndIndent
      \Statex

      \State On (\textsc{fund}, $c$, hops, \texttt{sub\_parties} = (fundee,
      counterparty), \texttt{outer\_parties} = (\charlie, \dave) by
      \environment:
      \Indent
        \State ensure $\mathit{State} \in \{\textsc{open base}, \textsc{open
        virtual}\}$
        \State do the same as in \fchan
        (Fig.~\ref{code:functionality:chan:skeleton:virtual},
        lines~\ref{code:functionality:chan:skeleton:virtual:fund}-\ref{code:functionality:chan:skeleton:virtual:fund:store})
        TODO: make sure it makes sense
        \State do VChan() with hops -- TODO
        \State output (\textsc{ok}) to \environment
      \EndIndent
      \Statex

      \State \Comment{notification to fundee}
      \State On (\textsc{allow fund}, \dots) by \charlie, act as \fchan
      (Fig~\ref{code:functionality:chan:skeleton:virtual},
      line~\ref{code:functionality:chan:skeleton:virtual:allow_fund}):
    \end{algorithmic}
  \end{protocolbox}
  \caption{}
  \label{code:protocol:chan:skeleton:virtual}
\end{figure}
