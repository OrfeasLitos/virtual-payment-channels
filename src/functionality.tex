\TODO{Add support for cooperative adding multiple virtuals to single channel as
future work (needs cooperation by all hops of all existing virtuals of current
channel)}
\TODO{Add support for cooperative closing as future work}

\begin{figure}[H]
  \begin{systembox}{\fchan{} -- general message handling rules}
    \begin{itemize}
      \item On receiving input (\texttt{msg}) by \environment to $P \in
      \{\alice, \bob\}$, handle it according to the corresponding rule in
      Fig~\ref{code:functionality:state-machine-1} or
      Fig~\ref{code:functionality:state-machine-2} (if any) and subsequently
      send (\textsc{relay}, \texttt{msg}, $P$, \environment, input) \adversary.
      \Comment{all messages by \environment are relayed to \adversary}
      \item On receiving (\texttt{msg}) by $R \neq \environment$ to $P \in
      \{\alice, \bob\}$ by means of $\texttt{mode} \in \{\mathrm{input},
      \mathrm{output}, \mathrm{network}\}$, send (\textsc{relay}, \texttt{msg},
      $P$, $R$, \texttt{mode}) to \adversary.  \Comment{all messages by machines
      other than \environment are relayed to \adversary}
      \item On receiving (\textsc{relay}, \texttt{msg}, $P$, $R$, \texttt{mode})
      by \adversary ($\texttt{mode} \in \{\mathrm{input}, \mathrm{output},
      \mathrm{network}\}$, $P \in \{\alice, \bob\}$), relay \texttt{msg} to $R$
      as $P$ by means of \texttt{mode}. \Comment{\adversary fully controls
      outgoing messages by \fchan}
      \item On receiving (\textsc{info}, \texttt{msg}) by \adversary, handle
      (\texttt{msg}) according to the corresponding rule in
      Fig~\ref{code:functionality:state-machine-1} or
      Fig~\ref{code:functionality:state-machine-2} (if any). After handling the
      message or after an ``ensure'' fails, send (\textsc{handled},
      \texttt{msg}) to \adversary. \Comment{(\textsc{info}, \texttt{msg})
      messages by \simulator always return control to \simulator without any
      side-effect to any other ITI, except if \fchan halts}
    \end{itemize}
  \end{systembox}
  \caption{}
  \label{code:functionality:rules}
\end{figure}

\begin{figure}[H]
  \begin{systembox}{\fchan{} -- state machine, Pt. 1}
    \begin{algorithmic}[1]
      \State On initalisation:
      \Indent
        \State $\pk{A} \gets \bot$; $\pk{B} \gets \bot$
        \State $\balance{A} \gets 0$; $\balance{B} \gets 0$
        \State $\texttt{is\_corrupted\_or\_negligent}_A \gets$ False;
        $\texttt{is\_corrupted\_or\_negligent}_B \gets$ False;
        \State $\itistate \gets \bot$
      \EndIndent
      \Statex

      \State On (\textsc{became corrupted or negligent}, $P$) by \adversary:
      \Indent
        \State $\texttt{is\_corrupted\_or\_negligent}_P \gets$ True
      \EndIndent
      \Statex

      \State On (\textsc{init}, $\pk{}$) to $P$ by \environment:
      \Indent
        \IfThenElse{$P = \bob$}{$\bar{P} \gets \alice$}{$\bar{P} \gets \bob$}
        \State ensure $\itistate \in \{\bot, \textsc{init}_{\bar{P}}\}$
        \State $\pk{P} \gets \pk{}$
        \IfThenElse{$\itistate = \bot$}{$\itistate \gets
        \textsc{tentative-init}_P$}{$\itistate \gets \textsc{tentative-init}$}
      \EndIndent
      \Statex

      \State On (\textsc{init}, $P$) by \adversary:
      \Indent
        \IfThen{$\itistate = \textsc{tentative-init}_P$}{$\itistate \gets
        \textsc{init}_P$}
        \IfThen{$\itistate = \textsc{tentative-init}$}{$\itistate \gets
        \textsc{init}$}
      \EndIndent
      \Statex

      \State On (\textsc{open}, $x$, $\dots$) to \alice by \environment:
      \Indent
        \State ensure $\itistate = \textsc{init}$
        \State $\balance{A} \gets x$; $\balance{B} \gets 0$
        \State $\itistate \gets \textsc{tentative-open}$
      \EndIndent
      \Statex

      \State On (\textsc{open}) by \adversary:
      \Indent
        \State ensure $\itistate = \textsc{tentative-open}$
        \State $\itistate \gets \textsc{open}$
      \EndIndent
      \Statex

      \State On (\textsc{pay}, $x$) to $P$ by \environment:
      \Indent
        \State ensure $\itistate = \textsc{open}$
        \State $c \gets x$
        \IfThenElse{$P = \alice$}{$S \gets \alice$; $\bar{S} \gets \bob$}{$S
        \gets \bob$; $\bar{S} \gets \alice$}
        \State $\itistate \gets \textsc{paying}$
      \EndIndent
      \Statex

      \State On (\textsc{pay ok}) by \adversary:
      \Indent
        \State ensure $\itistate = \textsc{paying}$
        \State $\balance{S} \gets \balance{S} - c$; $\balance{\bar{S}} \gets
        \balance{\bar{S}} + c$
        \State forget $c, S, \bar{S}$
        \State $\itistate \gets \textsc{open}$
      \EndIndent
    \end{algorithmic}
  \end{systembox}
  \caption{}
  \label{code:functionality:state-machine-1}
\end{figure}

\begin{figure}[H]
  \begin{systembox}{\fchan{} -- state machine, Pt. 2}
    \begin{algorithmic}[1]
      \State On (\textsc{fund me}, $x$, $\dots$) to $P$ by $R$:
      \Indent
        \State ensure $R$ is an ITI that runs \fchan or \pchan code
        \State ensure $\itistate = \textsc{open}$
        \State $c \gets x$
        \IfThenElse{$P = \alice$}{$S \gets \alice$}{$S \gets \bob$}
        \State $\itistate \gets \textsc{funding}$
      \EndIndent
      \Statex

      \State On (\textsc{fund ok}) by \adversary:
      \Indent
        \State ensure $\itistate = \textsc{funding}$
        \State $\balance{S} \gets \balance{S} - c$
        \State forget $c, S$
        \State $\itistate \gets \textsc{open}$
      \EndIndent
      \Statex

      \State On (\textsc{close}) by \environment:
      \Indent
        \State ensure $\itistate = \textsc{open}$
        \State $\itistate \gets \textsc{closing}$
      \EndIndent
      \Statex

      \State On (\textsc{close}) by \adversary:
      \Indent
        \State ensure $\itistate \in \{\textsc{open}, \textsc{closing},
        \textsc{paying}, \textsc{funding}\}$
        \For{$P \in \{A, B\}$}
          \If{$\texttt{is\_corrupted\_or\_negligent}_P =$ False}
            \State input (\textsc{read}) to \ledger as $P$ and assign ouput to
            $\Sigma_P$
            \State $\coins{P} \gets$ sum of coins exclusively spendable by
            $\pk{P}$ in $\Sigma_P$
          \EndIf
        \EndFor
        \State $\texttt{check}_A \gets \texttt{is\_corrupted\_or\_negligent}_A
        \vee \coins{A} \geq \balance{A}$
        \State $\texttt{check}_B \gets \texttt{is\_corrupted\_or\_negligent}_B
        \vee \coins{B} \geq \balance{B}$
        \If{$\texttt{check}_A \wedge \texttt{check}_B$}
          \State $\itistate \gets \textsc{closed}$
        \Else \: \Comment{balance security is broken}
          \State halt
          \label{code:functionality:state-machine-2:halt}
        \EndIf
      \EndIndent
    \end{algorithmic}
  \end{systembox}
  \caption{}
  \label{code:functionality:state-machine-2}
\end{figure}
